#/bin/bash

tmp_folder="/tmp"
file_name="online-valid.csv"
file_expiry_mins=60
search_string=$1
phishtank_api_key="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"

# first see if the file exists, and if so, if it is stale
if [ -f $tmp_folder/$file_name ]
then
        # echo "file exists..."
        file_expired=$( find $tmp_folder/$file_name -mmin +$file_expiry_mins | egrep '.*' )
else
#       echo "file not present..."
        file_expired=true
fi

# if the file needs to be (re)downloaded, do so
if [ $file_expired ]
then
        #echo "file expired...refreshing..."
        wget -q -O $tmp_folder/$file_name".bz2" 'http://data.phishtank.com/data/$phishtank_api_key/online-valid.csv.bz2'
        if [[ $? -ne 0 ]]; then
                echo "UNKNOWN: unable to download Phishtank file"
                rm $tmp_folder/$file_name".bz2"
                exit 3
        else
                bunzip2 -q -f $tmp_folder/$file_name".bz2"
                if [[ $? -ne 0 ]]; then
                        echo "UNKNOWN: unable to bunzip2 Phishtank file"
                        exit 3
                fi
        fi
fi

# check for badness
grep -l $search_string $tmp_folder/$file_name

if [ $? != 1 ];
then
        output=$(grep $search_string $tmp_folder/$file_name)
        echo "CRITICAL: $search_string - $output"
        exit 2
else
        echo "OK: $search_string"
        exit 0
fi

echo "UNKNOWN: Should never have reached this point"
exit 3
